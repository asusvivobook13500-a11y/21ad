<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Arxiv - Remote Auth</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #0f0f11;
            --card-border: #1f1f22;
            --primary: #6d28d9;
            --text-white: #ffffff;
            --text-gray: #9ca3af;
            --yellow: #eab308;
            --red: #ef4444;
            --blue: #3b82f6;
            --neon-green: #22c55e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-white); padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 600px; flex-grow: 1; }

        header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; 
            background: #0a0a0c; padding: 12px 18px; border-radius: 16px; border: 1px solid var(--card-border);
            width: 100%;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .mini-counter { background: rgba(109, 40, 217, 0.1); border: 1px solid var(--primary); padding: 4px 10px; border-radius: 10px; font-size: 13px; }

        .header-btns { display: flex; align-items: center; gap: 10px; }
        .add-btn { 
            display: none; background: var(--primary); color: white; border: none; 
            padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 700; 
            font-size: 13px; align-items: center; gap: 6px; white-space: nowrap;
        }
        .admin-btn {
            background: rgba(109, 40, 217, 0.1); border: 1px solid var(--primary);
            color: var(--primary); padding: 10px; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; transition: 0.3s;
        }
        .admin-btn.waiting { border-color: var(--yellow); color: var(--yellow); animation: pulse 1.5s infinite; }
        .admin-btn.logged-in { border-color: var(--red); color: var(--red); background: rgba(239, 68, 68, 0.1); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        #video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .video-card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 20px; padding: 14px; display: flex; flex-direction: column; gap: 12px; }
        .video-card.watched { border-color: var(--neon-green); opacity: 0.8; }
        
        .video-title { font-size: 13px; font-weight: 600; line-height: 1.4; height: 36px; overflow: hidden; }
        .video-preview-box { width: 100%; aspect-ratio: 16/9; background: #18181b; border-radius: 12px; overflow: hidden; border: 1px solid #27272a; }
        .video-preview-box img { width: 100%; height: 100%; object-fit: cover; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(8px); }
        .modal { background: #121214; padding: 25px; border-radius: 24px; width: 92%; max-width: 380px; border: 1px solid #333; text-align: center; }
        .modal input, .modal textarea { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: white; border-radius: 10px; margin-bottom: 12px; outline: none; }
        .save-btn { background: var(--primary); color: white; border: none; padding: 14px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; }

        .loader { border: 3px solid #333; border-top: 3px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 450px) { #video-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <h1>Arxiv</h1>
            <div class="mini-counter">Soni: <b id="total-count">0</b></div>
        </div>
        <div class="header-btns">
            <button id="add-btn-element" class="add-btn" onclick="openM()">Qo'shish</button>
            <button id="admin-main-btn" class="admin-btn" onclick="handleAdminAuth()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            </button>
        </div>
    </header>
    <div id="video-grid"></div>
</div>

<div class="modal-overlay" id="auth-modal">
    <div class="modal">
        <h3>Tasdiqlash kutilmoqda...</h3>
        <p style="font-size: 13px; color: var(--text-gray); margin-top: 10px;">Telegram botingizga kirish so'rovi yuborildi.</p>
        <div class="loader"></div>
        <button onclick="cancelAuth()" style="background:none; border:none; color:var(--red); cursor:pointer;">Bekor qilish</button>
    </div>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <h3 id="modal-title" style="margin-bottom:20px;">Ma'lumotlar</h3>
        <input type="text" id="v-title" placeholder="Sarlavha">
        <input type="text" id="v-link" placeholder="YouTube Link">
        <input type="text" id="v-time" placeholder="Vaqt (00:00:00)" maxlength="8" oninput="formatTime(this)">
        <textarea id="v-note" placeholder="Qaydlar..." rows="3"></textarea>
        <button class="save-btn" onclick="save()">Saqlash</button>
        <button onclick="closeM()" style="background:none; border:none; color:#555; width:100%; margin-top:12px; cursor:pointer">Bekor qilish</button>
    </div>
</div>

<script>
    const BOT_TOKEN = '8435664756:AAEWyflGuuuNHbR4H2mW-I8XT1WH3L7vcBk';
    const ADMIN_CHAT_ID = '5256241453';
    const DB_KEY = 'chingiz_archive_final_v2';
    
    let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
    let isAdmin = false;
    let authCheckInterval = null;
    let lastUpdateId = 0;
    let editIdx = null;

    function handleAdminAuth() {
        if (isAdmin) {
            if(confirm("Admin rejimidan chiqish?")) { isAdmin = false; updateUI(); }
        } else {
            startBotAuth();
        }
    }

    async function startBotAuth() {
        document.getElementById('auth-modal').style.display = 'flex';
        document.getElementById('admin-main-btn').classList.add('waiting');

        const text = "üîî Diqqat! Saytingizga kirish uchun ruxsat so'ralmoqda.\n\nQurilma: " + navigator.platform + "\nVaqt: " + new Date().toLocaleTimeString();
        const keyboard = {
            inline_keyboard: [[
                { text: "‚úÖ Tasdiqlash", callback_data: "auth_ok" },
                { text: "‚ùå Rad etish", callback_data: "auth_no" }
            ]]
        };

        try {
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, text: text, reply_markup: keyboard })
            });
            
            // Polling boshlash
            await getLatestUpdateId();
            authCheckInterval = setInterval(checkBotResponse, 2000);
        } catch (e) {
            alert("Botga ulanishda xato!");
            cancelAuth();
        }
    }

    async function getLatestUpdateId() {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-1`);
        const data = await res.json();
        if (data.result.length > 0) lastUpdateId = data.result[0].update_id;
    }

    async function checkBotResponse() {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}`);
        const data = await res.json();

        data.result.forEach(update => {
            lastUpdateId = update.update_id;
            if (update.callback_query) {
                const action = update.callback_query.data;
                if (action === "auth_ok") {
                    isAdmin = true;
                    stopAuth();
                    updateUI();
                } else if (action === "auth_no") {
                    stopAuth();
                    alert("Kirish rad etildi!");
                }
            }
        });
    }

    function stopAuth() {
        clearInterval(authCheckInterval);
        document.getElementById('auth-modal').style.display = 'none';
        document.getElementById('admin-main-btn').classList.remove('waiting');
    }

    function cancelAuth() { stopAuth(); }

    function updateUI() {
        document.getElementById('add-btn-element').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('admin-main-btn').className = isAdmin ? 'admin-btn logged-in' : 'admin-btn';
        render();
    }

    function getYTId(url) {
        const reg = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const m = url.match(reg);
        return (m && m[2].length === 11) ? m[2] : null;
    }

    function formatTime(el) {
        let v = el.value.replace(/\D/g, '');
        let r = "";
        if(v.length > 0) r = v.substring(0,2);
        if(v.length > 2) r += ":" + v.substring(2,4);
        if(v.length > 4) r += ":" + v.substring(4,6);
        el.value = r;
    }

    function render() {
        const grid = document.getElementById('video-grid');
        grid.innerHTML = '';
        let list = db.map((v, i) => ({...v, realIdx: i})).sort((a,b) => a.isWatched - b.isWatched);

        list.forEach(v => {
            const ytId = getYTId(v.url);
            const thumb = ytId ? `https://img.youtube.com/vi/${ytId}/mqdefault.jpg` : 'https://via.placeholder.com/320x180/111/333';
            
            grid.innerHTML += `
                <div class="video-card ${v.isWatched ? 'watched' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <span class="video-title">${v.name}</span>
                        ${isAdmin ? `
                        <div style="display:flex; gap:5px">
                            <button onclick="edit(${v.realIdx})" style="border:none; background:none; color:var(--yellow); cursor:pointer">‚úé</button>
                            <button onclick="del(${v.realIdx})" style="border:none; background:none; color:var(--red); cursor:pointer">‚úï</button>
                        </div>` : `<button onclick="toggleW(${v.realIdx})" style="border:none; background:none; cursor:pointer">${v.isWatched ? '‚úÖ' : 'üëÅÔ∏è'}</button>`}
                    </div>
                    <a href="${v.url}" target="_blank" class="video-preview-box">
                        <img src="${thumb}">
                    </a>
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--blue)">
                        <span>${v.time || '00:00:00'}</span>
                        <span onclick="alert('Qayd: ${v.note || 'Yoq'}')" style="cursor:pointer; color:var(--text-gray)">üìù</span>
                    </div>
                </div>`;
        });
        document.getElementById('total-count').innerText = db.length;
    }

    function toggleW(i) { db[i].isWatched = !db[i].isWatched; localStorage.setItem(DB_KEY, JSON.stringify(db)); render(); }
    function save() {
        const d = { name: document.getElementById('v-title').value, url: document.getElementById('v-link').value, time: document.getElementById('v-time').value, note: document.getElementById('v-note').value, isWatched: editIdx!==null ? db[editIdx].isWatched : false };
        if(!d.name || !d.url) return alert("To'ldiring!");
        if(editIdx===null) db.push(d); else db[editIdx]=d;
        localStorage.setItem(DB_KEY, JSON.stringify(db)); closeM(); render();
    }
    function edit(i) { editIdx=i; document.getElementById('v-title').value=db[i].name; document.getElementById('v-link').value=db[i].url; document.getElementById('v-time').value=db[i].time; document.getElementById('v-note').value=db[i].note; openM(); }
    function del(i) { if(confirm("O'chirish?")) { db.splice(i,1); localStorage.setItem(DB_KEY, JSON.stringify(db)); render(); } }
    function openM() { document.getElementById('modal').style.display='flex'; }
    function closeM() { document.getElementById('modal').style.display='none'; editIdx=null; document.querySelectorAll('.modal input, .modal textarea').forEach(i => i.value = ''); }

    render();
</script>
</body>
</html>
