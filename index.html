<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Arxiv - Shaxsiy Admin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #0f0f11;
            --card-border: #1f1f22;
            --primary: #6d28d9;
            --text-white: #ffffff;
            --text-gray: #9ca3af;
            --yellow: #eab308;
            --red: #ef4444;
            --blue: #3b82f6;
            --neon-green: #22c55e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-white); padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 600px; flex-grow: 1; }

        header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; 
            background: #0a0a0c; padding: 12px 18px; border-radius: 16px; border: 1px solid var(--card-border);
            width: 100%;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .mini-counter { background: rgba(109, 40, 217, 0.1); border: 1px solid var(--primary); padding: 4px 10px; border-radius: 10px; font-size: 13px; }

        .header-btns { display: flex; align-items: center; gap: 10px; }
        .add-btn { 
            display: none; background: var(--primary); color: white; border: none; 
            padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 700; 
            font-size: 13px; align-items: center; gap: 6px; white-space: nowrap;
        }
        .admin-btn {
            background: rgba(109, 40, 217, 0.1); border: 1px solid var(--card-border);
            color: var(--text-gray); padding: 10px; border-radius: 12px;
            display: flex; align-items: center; font-size: 12px; font-weight: bold; border: 1px solid #333;
        }
        .admin-btn.active-admin { border-color: var(--neon-green); color: var(--neon-green); background: rgba(34, 197, 94, 0.1); }

        #video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }

        .video-card { 
            background: var(--card-bg); border: 1px solid var(--card-border); 
            border-radius: 20px; padding: 14px; display: flex; flex-direction: column; gap: 12px; transition: 0.3s;
        }
        .video-card.watched { border-color: var(--neon-green); opacity: 0.8; }
        .video-card.watched img { filter: grayscale(1); }

        .video-title { font-size: 13px; font-weight: 600; flex: 1; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .video-preview-box { width: 100%; aspect-ratio: 16/9; background: #18181b; border-radius: 12px; overflow: hidden; border: 1px solid #27272a; }
        .video-preview-box img { width: 100%; height: 100%; object-fit: cover; }

        .video-footer { display: flex; justify-content: space-between; align-items: center; }
        .time-badge { 
            font-size: 11px; color: var(--blue); font-weight: 700; background: rgba(59, 130, 246, 0.1); 
            padding: 5px 10px; border-radius: 8px; display: flex; align-items: center; gap: 5px;
        }

        .icon-btn { background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 4px; border-radius: 6px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(8px); }
        .modal { background: #121214; padding: 25px; border-radius: 24px; width: 92%; max-width: 380px; border: 1px solid #333; }
        .modal input, .modal textarea { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: white; border-radius: 10px; margin-bottom: 12px; outline: none; font-size: 14px; }
        .save-btn { background: var(--primary); color: white; border: none; padding: 14px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; }

        @media (max-width: 450px) { #video-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <h1>Arxiv</h1>
            <div class="mini-counter">Soni: <b id="total-count">0</b></div>
        </div>
        <div class="header-btns">
            <button id="add-btn-element" class="add-btn" onclick="openM()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Qo'shish
            </button>
            <div id="admin-badge" class="admin-btn">
                <span id="admin-text">Kutilmoqda...</span>
            </div>
        </div>
    </header>
    <div id="video-grid"></div>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <h3 id="modal-title" style="margin-bottom:20px; text-align:center">Yangi Video</h3>
        <input type="text" id="v-title" placeholder="Video nomi">
        <input type="text" id="v-link" placeholder="YouTube URL Link">
        <input type="text" id="v-time" placeholder="Davomiyligi (00:00:00)" maxlength="8" oninput="formatTime(this)">
        <textarea id="v-note" placeholder="Eslatma yoki qaydlar..." rows="3"></textarea>
        <button class="save-btn" onclick="save()">Saqlash</button>
        <button onclick="closeM()" style="background:none; border:none; color:#555; width:100%; margin-top:12px; cursor:pointer">Bekor qilish</button>
    </div>
</div>

<script>
    // --- ADMIN SOZLAMASI ---
    const MY_CHAT_ID = 5256241453; 
    const DB_KEY = 'chingiz_archive_final_v2';
    
    const tg = window.Telegram.WebApp;
    let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
    let isAdmin = false;
    let editIdx = null;

    // Telegram orqali shaxsni tasdiqlash
    function checkIdentity() {
        tg.ready();
        const user = tg.initDataUnsafe?.user;
        
        // Agar foydalanuvchi ID si sizniki bo'lsa adminlik beriladi
        if (user && user.id === MY_CHAT_ID) {
            isAdmin = true;
            document.getElementById('admin-text').innerText = "Admin: " + (user.first_name || "Siz");
            document.getElementById('admin-badge').classList.add('active-admin');
        } else {
            isAdmin = false;
            document.getElementById('admin-text').innerText = "Foydalanuvchi";
        }
        updateUI();
    }

    function getYTId(url) {
        const reg = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const m = url.match(reg);
        return (m && m[2].length === 11) ? m[2] : null;
    }

    function formatTime(el) {
        let v = el.value.replace(/\D/g, '');
        let r = "";
        if(v.length > 0) r = v.substring(0,2);
        if(v.length > 2) r += ":" + v.substring(2,4);
        if(v.length > 4) r += ":" + v.substring(4,6);
        el.value = r;
    }

    function updateUI() {
        document.getElementById('add-btn-element').style.display = isAdmin ? 'flex' : 'none';
        render();
    }

    function render() {
        const grid = document.getElementById('video-grid');
        grid.innerHTML = '';
        let list = db.map((v, i) => ({...v, realIdx: i})).sort((a,b) => a.isWatched - b.isWatched);

        list.forEach(v => {
            const ytId = getYTId(v.url);
            const thumb = ytId ? `https://img.youtube.com/vi/${ytId}/mqdefault.jpg` : 'https://via.placeholder.com/320x180/111/333?text=Link+Xato';
            const eyeColor = v.isWatched ? 'var(--neon-green)' : '#555';
            
            grid.innerHTML += `
                <div class="video-card ${v.isWatched ? 'watched' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                        <span class="video-title">${v.name}</span>
                        ${isAdmin ? `
                        <div style="display:flex; gap:4px">
                            <button class="icon-btn" onclick="edit(${v.realIdx})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--yellow)" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="icon-btn" onclick="del(${v.realIdx})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                        </div>` : `
                        <button class="icon-btn" onclick="toggleW(${v.realIdx})">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${eyeColor}" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>${v.isWatched ? '' : '<line x1="1" y1="1" x2="23" y2="23" stroke="red"></line>'}</svg>
                        </button>`}
                    </div>
                    <a href="${v.url}" target="_blank" style="text-decoration:none; ${v.isWatched ? 'pointer-events:none' : ''}">
                        <div class="video-preview-box"><img src="${thumb}"></div>
                    </a>
                    <div class="video-footer">
                        <div class="time-badge">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            ${v.time || '00:00:00'}
                        </div>
                        <button class="icon-btn" onclick="alert('Eslatma: ${v.note ? v.note.replace(/'/g, "\\'") : 'Mavjud emas'}')">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-gray)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                        </button>
                    </div>
                </div>`;
        });
        document.getElementById('total-count').innerText = db.length;
    }

    function toggleW(i) { db[i].isWatched = !db[i].isWatched; localStorage.setItem(DB_KEY, JSON.stringify(db)); render(); }
    
    function save() {
        const title = document.getElementById('v-title').value;
        const url = document.getElementById('v-link').value;
        if(!title || !url) return alert("Sarlavha va Linkni to'ldiring!");

        const data = { 
            name: title, 
            url: url, 
            time: document.getElementById('v-time').value, 
            note: document.getElementById('v-note').value, 
            isWatched: editIdx !== null ? db[editIdx].isWatched : false 
        };

        if(editIdx === null) db.push(data); else db[editIdx] = data;
        localStorage.setItem(DB_KEY, JSON.stringify(db)); 
        closeM(); 
        render();
    }

    function edit(i) { 
        editIdx = i; 
        document.getElementById('v-title').value = db[i].name; 
        document.getElementById('v-link').value = db[i].url; 
        document.getElementById('v-time').value = db[i].time; 
        document.getElementById('v-note').value = db[i].note; 
        document.getElementById('modal-title').innerText = "Tahrirlash";
        openM(); 
    }

    function del(i) { if(confirm("Ushbu videoni o'chirmoqchimisiz?")) { db.splice(i,1); localStorage.setItem(DB_KEY, JSON.stringify(db)); render(); } }
    function openM() { document.getElementById('modal').style.display = 'flex'; }
    function closeM() { 
        document.getElementById('modal').style.display = 'none'; 
        editIdx = null; 
        document.getElementById('modal-title').innerText = "Yangi Video";
        document.querySelectorAll('.modal input, .modal textarea').forEach(i => i.value = ''); 
    }

    // Ishga tushirish
    checkIdentity();
</script>
</body>
</html>